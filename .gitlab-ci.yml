# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/pipeline/#customization
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
default:
  image: mcr.microsoft.com/dotnet/sdk:latest
stages:
- deploy
- release
variables:
  NUPKG_LOCATION: "/tmp/packages"
  ARTIFACTS_LOCATION: "$CI_PROJECT_DIR/out"
deploy:
  stage: deploy
  rules:
  - if: "$CI_COMMIT_TAG"
    when: never
  - when: always
  variables:
    GIT_DEPTH: 0
    GIT_CLEAN_FLAGS: none
  artifacts:
    reports:
      dotenv: gitversion.properties
  before_script:
  - rm -rf $ARTIFACTS_LOCATION
  script:
  - dotnet tool install GitVersion.Tool -g
  - export PATH="$PATH:/root/.dotnet/tools"
  - dotnet-gitversion /output buildserver
  - dotnet restore --locked-mode --packages $NUPKG_LOCATION
  - dotnet pack --packages $NUPKG_LOCATION -o $ARTIFACTS_LOCATION -c Release
  - dotnet nuget push "$ARTIFACTS_LOCATION/*.nupkg" --api-key $NUGET_ORG_API_KEY --source
    https://api.nuget.org/v3/index.json
  environment: production
release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
  - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
  needs:
  - job: deploy
    optional: true
  script:
  - echo "Running the release job."
  release:
    tag_name: "$GitVersion_MajorMinorPatch"
    tag_message: Release $GitVersion_MajorMinorPatch
    description: Release $GitVersion_MajorMinorPatch created using the release-cli.
include:
- template: Auto-DevOps.gitlab-ci.yml
